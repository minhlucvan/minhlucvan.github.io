<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Minh Luc&#39;s Blog"><title>viết một chương trình cho phép cài plugin trong java như thế nào? - Minh Luc&#39;s Blog</title><meta name="author" content="Minh Luc"><script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Minh Luc","sameAs":["https://github.com/minhlucvan","http://stackoverflow.com/users","https://twitter.com/","https://facebook.com/minhlucvan.3","https://plus.google.com/","https://www.linkedin.com/profile/","mailto:luk.mink@gmail.com"],"image":"https://www.buildabear.com/dw/image/v2/BBNG_PRD/on/demandware.static/-/Sites-buildabear-master/default/dwdfa7c1cf/27618_27630_25342_24630x.jpg?sw=600&sh=600&sm=fit&q=70"},"articleBody":"Chả là đang tập tọe làm wordpress plugin, bỗng dưng nảy ra câu hỏi thế cài đặt plugin trong java như thế nào. Trước giờ cũng chỉ làm theo kiểu yêu cầu đến đâu viết đến đấy chứ chưa được làm kiểu plugin này bao giờ cả. Đành hỏi bác Gúc vậy. sau một hồi đào bới cũng gọi là nắm đưọc đôi phần, note ra đây cho bác nào cùng chung thắc mắc.plugin là khỉ gì?Nói thế chứ plugin chắc không lạ gì rồi, điển hình như các thể loại trình duyệt phổ biến như Chrome, Firefox, Opera kiểu gì mỗi cái chả cài một đống plugin đến khi trình duyệt có gì bất thường lại chả lôi đầu mấy thằng plugin ra kiểm ra đầu tiên. một cách đơn giản thì Plugin chính là một bộ phần mềm cài đặt để hỗ trợ, mở rộng chức năng cho một phần mềm ứng dụng lớn hơn, dựa trận nhưng giao thức và API do phần mềm lớn cung cấp.plugin có gì hay ho?Kiến trúc plugin thực sự rất tuyệt vời, nó cho phép mở rộng (thập chí là thay đổi) các chức năng của các host applications (tạm gọi là ứng dụng chủ đi), với một thiết kế tốt các ứng dụng có thể cắm thêm bao nhiêu chức năng tùy thích mỗi plugin mang đến một tiện ích dẫn đến khả năng mở rộng của hệ thống là cực kỳ tuyệt vời mình xin phép đưọc nhai lại một lần nữa là phải thiết kế cho tốt nhé không là ứng úng lỗi tùm lum đó.Với cộng đồng mã nguồn mở phát triển như vũ bão ngày nay, với một ứng dụng có base tốt và một plugin API tối thì tốc độ phát triển sẽ không thể tin nổi. VD như slack một hệ thống nhắn tin và trao đổi công việc đang rất nổi tuy cũng chỉ mới phát triển được vài năm nhưng số lượng plugin trong kho của slack đã rất khổng lồ hầu hết là do các bên thứ ba phảt triển, thực sự nâng giá trị của ứng dụng ban đầu lên gấp nhiều lần mà một team không thể làm hết được.rồi, thế cài đặt thằng này thế nào?Đối với các script language như Javascript, PHP, python… với dặc điểm mỗi lần chạy là một lần thông dịch thì có vẻ không gặp trở ngại gì chỉ việc dùng một thằng callback hay closure là xong cái này mình sẽ nói đến vào một ngày đẹp trời không xa. với java câu chuyện có vẻ không dễ dàng như thế, java 8 mới ra mắt tính năng Thinking cho phép cài đặt callback &amp; closure một cách khá dễ dàng còn các ver thấp hơn thì không có cái gì tương tự cả, mình thì gà java nên cũng thấy vụ này hơi khoai.Về cơ bản để có thể cắm được plugin thì ứng dụng phải có kiến trúc đơn giản nhất như trong hình trên, hai thành phần cơ bản đó là application core và plugin manager:- application core: thằng này là ứng dụng chủ có nhiệm bụ bào đảm logic của hệ thống, thực hiện các tác vụ và hook (gọi) các plugin thực hiện nhiệm vụ của mình trong runtime.- plugins manager: thằng chịu sự chỉ đạo của thằng core có nhiệm vụ đăng ký các plugin thêm, gỡ, bật, tắt các plugin.Để có thể cắm được plugin ta phải có một plugin interface đây là giao diện mà tất cả các plugin sẽ kế thừa, plugin manager sẻ load các plugins và initial (nôm na là tạo ra thực thể của mỗi plugin) vào trong một List các plugins rồi từ đó application core sẽ lần lưọt móc ra từ cái một và bắt nó thực hiện nhiệm vụ nhất định.Hì, mình giải thích củ chuối quá chắc ko ai hiểu nổi nhỉ. để trực quan sinh động mời ae xem ví dụ bên dưới.ví dụ trực quan nèỞ ví dụ này mình sẽ tạo một ứng dụng đơn giẩn với đầu vào là 1 số, các plugin sẽ đưọc thêm vào đê chế biến số đó để đưa ra kết quả cuối cùng cộng trừ nhân chia gì đó.Ok, đầu tiên chúng ta phải có một thằng interface chung cho các plugins. tạm gọi là PluginFunction.java đi.123456789101112131415public interface PluginFunction &#123;\t// let the application pass in a parameter\tpublic void setParameter (int param);\t// retrieve a result from the plugin\tpublic int getResult();\t// return the name of this plugin\tpublic String getPluginName();\t// can be called to determine whether the plugin\t// aborted execution due to an error condition\tpublic boolean hasError();&#125;Tiếp theo ta phải có một cái main để chạy logic của ứng dụng và gọi các plugin, ta gọi là PluginDemo.java chứa hàm main.1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889import java.io.File;import java.util.*;public class PluginDemo &#123;\t//parameter for plugins\tint count;\t// the directory where we keep the plugin classes\tString pluginsDir;\t// a list where we keep an initialized object of each plugin class\tList plugins;\tpublic static void main (String args[]) &#123;\t\tPluginDemo demo = new PluginDemo(args);\t\tdemo.getPlugins();\t\tdemo.runPlugins();\t&#125;\tPluginDemo (String args[]) &#123;\t\tif (args.length &gt; 0)\t\t\tcount = Integer.parseInt(args[0]);\t\telse\t\t\tcount = 1;\t\tif (args.length &gt; 1)\t\t\tpluginsDir = args[0];\t\telse\t\t\tpluginsDir = \"plugins\";\t\tplugins = new ArrayList();\t\tSystem.setSecurityManaghttps://analytics.google.com/analytics/web/?authuser=0#croverview/cr-overview/a79213161w118319613p123773431/er(new PluginSecurityManager(pluginsDir));\t&#125;\tprotected void getPlugins() &#123;\t\tFile dir = new File(System.getProperty(\"user.dir\") + File.separator + pluginsDir);\t\tClassLoader cl = new PluginClassLoader(dir);\t\tif (dir.exists() &amp;&amp; dir.isDirectory()) &#123;\t\t\t// we'll only load classes directly in this directory -\t\t\t// no subdirectories, and no classes in packages are recognized\t\t\tString[] files = dir.list();\t\t\tfor (int i=0; i&lt;files.length; i++) &#123;\t\t\t\ttry &#123;\t\t\t\t\t// only consider files ending in \".class\"\t\t\t\t\tif (! files[i].endsWith(\".class\"))\t\t\t\t\t\tcontinue;\t\t\t\t\tClass c = cl.loadClass(files[i].substring(0, files[i].indexOf(\".\")));\t\t\t\t\tClass[] intf = c.getInterfaces();\t\t\t\t\tfor (int j=0; j&lt;intf.length; j++) &#123;\t\t\t\t\t\tif (intf[j].getName().equals(\"PluginFunction\")) &#123;\t\t\t\t\t\t\t// the following line assumes that PluginFunction has a no-argument constructor\t\t\t\t\t\t\tPluginFunction pf = (PluginFunction) c.newInstance();\t\t\t\t\t\t\tplugins.add(pf);\t\t\t\t\t\t\tcontinue;\t\t\t\t\t\t&#125;\t\t\t\t\t&#125;\t\t\t\t&#125; catch (Exception ex) &#123;\t\t\t\t\tSystem.err.println(\"File \" + files[i] + \" does not contain a valid PluginFunction class.\");\t\t\t\t&#125;\t\t\t&#125;\t\t&#125;\t&#125;\tprotected void runPlugins() &#123;\t\tIterator iter = plugins.iterator();\t\twhile (iter.hasNext()) &#123;\t\t\tPluginFunction pf = (PluginFunction) iter.next();\t\t\ttry &#123;\t\t\t\tpf.setParameter(count);\t\t\t\tSystem.out.print(pf.getPluginName());\t\t\t\tSystem.out.print(\" ( \"+count+\" ) = \");\t\t\t\tif (pf.hasError()) &#123;\t\t\t\t\tSystem.out.println(\"there was an error during plugin initialization\");\t\t\t\t\tcontinue;\t\t\t\t&#125;\t\t\t\tint result = pf.getResult();\t\t\t\tif (pf.hasError())\t\t\t\t\tSystem.out.println(\"there was an error during plugin execution\");\t\t\t\telse\t\t\t\t\tSystem.out.println(result);\t\t\t\tcount++;\t\t\t&#125; catch (SecurityException secEx) &#123;\t\t\t\tSystem.err.println(\"plugin '\"+pf.getClass().getName()+\"' tried to do something illegal\");\t\t\t&#125;\t\t&#125;\t&#125;&#125;Ta thấy trong hàm getPlugins có một vòng for để load hết các class mà có interface là PluginFunction rồi tạo ra một thực thể của class đó và lưu vào mảng plugins. Sau đó hàm runPlugins sẽ duyệt qua tất cả cảc plugins set tham số chạy hàm run của từng plugin và in ra kết quả.Ngoài ra hàm getPlugins còn có một điều thú vị nữa chính là dòng setSecurityManager, vì đây là các plugins độc lập với hệ thống nên ta phhair xét quền hạn cho nó chứ nhỡ thanh niên nào vui tính lại cho cái plugin xóa hết hệ điều hành thì chỉ biết ngồi đấy mà khóc thôi 😭.Đây là nội dung file PluginSecurityManager.java123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106import java.io.File;/*** This is a fairly uptight security manager subclass. Classes loaded by* the PluginClassLoader are highly restricted in what they are allowed to do.* This is okay, because they're only supposed to calculate some values,* for which all necessary data is already available to them.** A SecurityManager consists of various methods that the system calls to* check whether certain sensitive operations should be allowed. These* methods can throw a SecurityException to prevent the operation from* happening. With this SecurityManager, we want to prevent untrusted* code that was loaded by a class loader from performing those sensitive operations.* So we use inherited SecurityManager methods to check whether the call is being* made by an untrusted class. If it is, we throw an exception.* Otherwise, we simply return, allowing the operation to proceed normally.*/public class PluginSecurityManager extends SecurityManager &#123;\tprivate String pluginDir = null;\tPluginSecurityManager (String dir) &#123;\t\tpluginDir = dir;\t&#125;\t/**\t * This is the basic method that tests whether there is a class loaded\t * by a ClassLoader anywhere on the stack. If so, it means that that\t * untrusted code is trying to perform some kind of sensitive operation.\t * We prevent it from performing that operation by throwing an exception.\t * trusted() is called by most of the check...() methods below.\t */\tprotected void trusted() &#123;\t\tif (inClassLoader()) throw new SecurityException();\t&#125;\t/**\t * These are all the specific checks that a security manager can\t * perform. They all just call one of the methods above and throw a\t * SecurityException if the operation is not allowed. This \t * SecurityManager subclass is perhaps a little too restrictive. For\t * example, it doesn't allow loaded code to read *any* system properties,\t * even though some of them are quite harmless.\t */\tpublic void checkCreateClassLoader() &#123; trusted(); &#125;\tpublic void checkAccess (Thread g) &#123; trusted(); &#125;\tpublic void checkAccess (ThreadGroup g) &#123; trusted(); &#125;\tpublic void checkExit (int status) &#123; throw new SecurityException(\"Not allowed.\"); &#125;\tpublic void checkExec (String cmd) &#123; trusted(); &#125;\tpublic void checkLink (String lib) &#123; trusted(); &#125;\tpublic void checkRead (java.io.FileDescriptor fd) &#123; trusted(); &#125;\tpublic void checkRead (String file) &#123;//\t\tString path = new File(file).getParentFile().getAbsolutePath();//\t\tif (! path.endsWith(pluginDir))\t\t\ttrusted();\t&#125;\tpublic void checkRead (String file, Object context) &#123; trusted(); &#125;\tpublic void checkWrite (java.io.FileDescriptor fd) &#123; trusted(); &#125;\tpublic void checkWrite (String file) &#123; trusted(); &#125;\tpublic void checkDelete (String file) &#123; trusted(); &#125;\tpublic void checkConnect (String host, int port) &#123; trusted(); &#125;\tpublic void checkConnect (String host,int port,Object context) &#123;trusted();&#125;\tpublic void checkListen (int port) &#123; trusted(); &#125;\tpublic void checkAccept (String host, int port) &#123; trusted(); &#125;\tpublic void checkMulticast (java.net.InetAddress maddr) &#123; trusted(); &#125;\tpublic void checkMulticast (java.net.InetAddress maddr, byte ttl) &#123; trusted(); &#125;\tpublic void checkPropertiesAccess() &#123; trusted(); &#125;\tpublic void checkPropertyAccess (String key) &#123;//\t\tif (! key.equals(\"user.dir\"))\t\t\ttrusted();\t&#125;\tpublic void checkPrintJobAccess() &#123; trusted(); &#125;\tpublic void checkSystemClipboardAccess() &#123; trusted(); &#125;\tpublic void checkAwtEventQueueAccess() &#123; trusted(); &#125;\tpublic void checkSetFactory() &#123; trusted(); &#125;\tpublic void checkMemberAccess (Class clazz, int which) &#123; trusted(); &#125;\tpublic void checkSecurityAccess (String provider) &#123; trusted(); &#125;\t/** Loaded code can only load classes from java.* packages */\tpublic void checkPackageAccess (String pkg) &#123; \t\tif (inClassLoader() &amp;&amp; !pkg.startsWith(\"java.\") &amp;&amp; !pkg.startsWith(\"javax.\"))\t\t\tthrow new SecurityException();\t&#125;\t/** Loaded code can't define classes in java.* or sun.* packages */\tpublic void checkPackageDefinition (String pkg) &#123; \t\tif (inClassLoader() &amp;&amp; ((pkg.startsWith(\"java.\") || pkg.startsWith(\"javax.\") || pkg.startsWith(\"sun.\"))))\t\t\tthrow new SecurityException();\t&#125;\t/** \t * This is the one SecurityManager method that is different from the\t * others. It indicates whether a top-level window should display an\t * \"untrusted\" warning. The window is always allowed to be created, so\t * this method is not normally meant to throw an exception. It should\t * return true if the window does not need to display the warning, and\t * false if it does. In this example, however, our text-based Service\t * classes should never need to create windows, so we will actually\t * throw an exception to prevent any windows from being opened.\t **/\tpublic boolean checkTopLevelWindow (Object window) &#123; \t\ttrusted();\t\treturn true; \t&#125;&#125;Ngoài ra ta còn cần 1 cái loader để load các plugins ra nữa PluginClassLoader.java123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687import java.io.*;  /**   * In order to impose tight security restrictions on untrusted classes but   * not on trusted system classes, we have to be able to distinguish between   * those types of classes. This is done by keeping track of how the classes   * are loaded into the system. By definition, any class that the interpreter   * loads directly from the CLASSPATH is trusted. This means that we can't   * load untrusted code in that way--we can't load it with Class.forName().   * Instead, we create a ClassLoader subclass to load the untrusted code.   * This one loads classes from a specified directory (which should not   * be part of the CLASSPATH).   */public class PluginClassLoader extends ClassLoader &#123;    /** This is the directory from which the classes will be loaded */    File directory;    /** The constructor. Just initialize the directory */    public PluginClassLoader (File dir) &#123;\t\tdirectory = dir;\t&#125;    /** A convenience method that calls the 2-argument form of this method */    public Class loadClass (String name) throws ClassNotFoundException &#123;       return loadClass(name, true);     &#125;    /**     * This is one abstract method of ClassLoader that all subclasses must     * define. Its job is to load an array of bytes from somewhere and to     * pass them to defineClass(). If the resolve argument is true, it must     * also call resolveClass(), which will do things like verify the presence     * of the superclass. Because of this second step, this method may be called to     * load superclasses that are system classes, and it must take this into account.     */    public Class loadClass (String classname, boolean resolve) throws ClassNotFoundException &#123;      try &#123;        // Our ClassLoader superclass has a built-in cache of classes it has        // already loaded. So, first check the cache.        Class c = findLoadedClass(classname);        // After this method loads a class, it will be called again to        // load the superclasses. Since these may be system classes, we've        // got to be able to load those too. So try to load the class as        // a system class (i.e. from the CLASSPATH) and ignore any errors        if (c == null) &#123;          try &#123; c = findSystemClass(classname); &#125;          catch (Exception ex) &#123;&#125;        &#125;        // If the class wasn't found by either of the above attempts, then        // try to load it from a file in (or beneath) the directory        // specified when this ClassLoader object was created. Form the        // filename by replacing all dots in the class name with        // (platform-independent) file separators and by adding the \".class\" extension.        if (c == null) &#123;          // Figure out the filename          String filename = classname.replace('.',File.separatorChar)+\".class\";          // Create a File object. Interpret the filename relative to the          // directory specified for this ClassLoader.          File f = new File(directory, filename);          // Get the length of the class file, allocate an array of bytes for          // it, and read it in all at once.          int length = (int) f.length();          byte[] classbytes = new byte[length];          DataInputStream in = new DataInputStream(new FileInputStream(f));          in.readFully(classbytes);          in.close();          // Now call an inherited method to convert those bytes into a Class          c = defineClass(classname, classbytes, 0, length);        &#125;        // If the resolve argument is true, call the inherited resolveClass method.        if (resolve) resolveClass(c);        // And we're done. Return the Class object we've loaded.        return c;      &#125;      // If anything goes wrong, throw a ClassNotFoundException error      catch (Exception ex) &#123; throw new ClassNotFoundException(ex.toString()); &#125;    &#125;&#125;Haiz, về cơ bản hệ thống setup thế là xong, tiếp theo ta sẽ cần 1 2 cái plugins để test thủ xem nó có chạy ổn không, ta sẽ đặt các file này trong thư mục plugins.Square.java tình bình phưng của tham số:12345678910111213141516171819202122232425/** * This plugin squares its argument. */public class Square implements PluginFunction &#123;\tint parameter = 0;\tpublic void setParameter (int param) &#123;\t\tparameter = param;\t&#125;\tpublic int getResult() &#123;\t\treturn parameter * parameter;\t&#125;\tpublic String getPluginName() &#123;\t\treturn \"Square\";\t&#125;\t// yes, this operation can fail, but we are going to ignore this here\tpublic boolean hasError() &#123;\t\treturn false;\t&#125;&#125;PlusOne.java cộng 1 đơn vị vào tham số:12345678910111213141516171819202122232425/** * This plugin adds one to the parameter. */public class PlusOne implements PluginFunction &#123;\tint parameter = 0;\tpublic void setParameter (int param) &#123;\t\tparameter = param;\t&#125;\tpublic int getResult() &#123;\t\treturn parameter + 1;\t&#125;\tpublic String getPluginName() &#123;\t\treturn \"PlusOne\";\t&#125;\t// yes, ths operation can fail, but we are going to ignore this here\tpublic boolean hasError() &#123;\t\treturn false;\t&#125;&#125;TryToExit.java thử cho thanh niên này lạm quền tý xem có đưọc không, trong PluginSecurityManager ta đã set không cho plugin thoát chương trình rồi.1234567891011121314151617181920212223242526/** * This plugin tries to call System.exit(), which the SecurityManager doesn't allow. */public class TryToExit implements PluginFunction &#123;\tpublic void setParameter (int param) &#123;\t\t// this function doesn't care about its parameter,\t\t// so it doesn't even store it for later use\t&#125;\tpublic int getResult() &#123;\t\t// The next line will be caught by the SecurityManagers 'checkExit' method.\t\tSystem.exit(0);\t\treturn 42;\t&#125;\tpublic String getPluginName() &#123;\t\treturn \"TryToExit\";\t&#125;\t// yes, this operation can fail, but we are going to ignore this here\tpublic boolean hasError() &#123;\t\treturn false;\t&#125;&#125;Tiếp theo là dịch và chạy thử, nếu không có gì sai thì sẽ thu được output như này, mình dùng java 8 nên có phun ra mấy cái Note, thôi kệ dù sao nó vẫn chạy được 😄:123456789minh@MINH-PC:~/Desktop/Plugin$ javac *.javaNote: PluginSecurityManager.java uses or overrides a deprecated API.Note: Recompile with -Xlint:deprecation for details.Note: PluginDemo.java uses unchecked or unsafe operations.Note: Recompile with -Xlint:unchecked for details.minh@MINH-PC:~/Desktop/Plugin$ java PluginDemoTryToExit ( 1 ) = plugin 'TryToExit' tried to do something illegalPlusOne ( 1 ) = 2Square ( 2 ) = 4Thực ra toppic này còn thêm vấn đề nữa là build ra file jar và cài đặt plugin bằng xml nhưng tạp thời thế này đã. xin hẹn ae một dịp khác.Xin chân thành cảm ơn bộ code mẫu của @Ulf Dittmer, các bạn code thể download code dể tham khảo.Phùu… cảm ơn ae đã theo dõi đến tận đây, bài đã dài tay quay đã mỏi mình xin phép dừng phím tại đây. chúc ae cuối tuần vui vẻ.xin chào thân ái và quết thắng.","dateCreated":"2016-08-06T19:08:51+07:00","dateModified":"2019-10-13T22:56:12+07:00","datePublished":"2016-08-06T19:08:51+07:00","description":"Chả là đang tập tọe làm wordpress plugin, bỗng dưng nảy ra câu hỏi thế cài đặt plugin trong java như thế nào. Trước giờ cũng chỉ làm theo kiểu yêu cầu đến đâu viết đến đấy chứ chưa được làm kiểu plugin này bao giờ cả. Đành hỏi bác Gúc vậy. sau một hồi đào bới cũng gọi là nắm đưọc đôi phần, note ra đây cho bác nào cùng chung thắc mắc.","headline":"viết một chương trình cho phép cài plugin trong java như thế nào?","image":["plugin_icon.jpg","plugin.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/"},"publisher":{"@type":"Organization","name":"Minh Luc","sameAs":["https://github.com/minhlucvan","http://stackoverflow.com/users","https://twitter.com/","https://facebook.com/minhlucvan.3","https://plus.google.com/","https://www.linkedin.com/profile/","mailto:luk.mink@gmail.com"],"image":"https://www.buildabear.com/dw/image/v2/BBNG_PRD/on/demandware.static/-/Sites-buildabear-master/default/dwdfa7c1cf/27618_27630_25342_24630x.jpg?sw=600&sh=600&sm=fit&q=70","logo":{"@type":"ImageObject","url":"https://www.buildabear.com/dw/image/v2/BBNG_PRD/on/demandware.static/-/Sites-buildabear-master/default/dwdfa7c1cf/27618_27630_25342_24630x.jpg?sw=600&sh=600&sm=fit&q=70"}},"url":"/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/","keywords":"design pattern, java","thumbnailUrl":"plugin_icon.jpg"}</script><meta name="description" content="Chả là đang tập tọe làm wordpress plugin, bỗng dưng nảy ra câu hỏi thế cài đặt plugin trong java như thế nào. Trước giờ cũng chỉ làm theo kiểu yêu cầu đến đâu viết đến đấy chứ chưa được làm kiểu plugi"><meta name="keywords" content="design pattern,java"><meta property="og:type" content="blog"><meta property="og:title" content="viết một chương trình cho phép cài plugin trong java như thế nào?"><meta property="og:url" content="/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/index.html"><meta property="og:site_name" content="Minh Luc&#39;s Blog"><meta property="og:description" content="Chả là đang tập tọe làm wordpress plugin, bỗng dưng nảy ra câu hỏi thế cài đặt plugin trong java như thế nào. Trước giờ cũng chỉ làm theo kiểu yêu cầu đến đâu viết đến đấy chứ chưa được làm kiểu plugi"><meta property="og:locale" content="vi"><meta property="og:image" content="/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/application-architecture.png"><meta property="og:updated_time" content="2019-10-13T15:56:12.638Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="viết một chương trình cho phép cài plugin trong java như thế nào?"><meta name="twitter:description" content="Chả là đang tập tọe làm wordpress plugin, bỗng dưng nảy ra câu hỏi thế cài đặt plugin trong java như thế nào. Trước giờ cũng chỉ làm theo kiểu yêu cầu đến đâu viết đến đấy chứ chưa được làm kiểu plugi"><meta name="twitter:image" content="/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/application-architecture.png"><meta name="twitter:creator" content="@minhlucvan"><meta property="og:image" content="https://www.buildabear.com/dw/image/v2/BBNG_PRD/on/demandware.static/-/Sites-buildabear-master/default/dwdfa7c1cf/27618_27630_25342_24630x.jpg?sw=600&amp;sh=600&amp;sm=fit&amp;q=70"><meta property="og:image" content="/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/plugin_icon.jpg"><meta class="swiftype" name="image" data-type="enum" content="/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/plugin_icon.jpg"><meta property="og:image" content="/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/plugin.png"><meta class="swiftype" name="image" data-type="enum" content="/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/plugin.png"><link rel="stylesheet" href="/assets/css/style-vauplnmuudawtrvs9qoe2qiqczrszudvtrtqf2khoqbe0hmw3ovkgnoc5u4n.min.css"></head><body><div id="blog"><header id="header" data-behavior="4"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/" aria-label="">Minh Luc&#39;s Blog</a></div><a class="header-right-picture" href="#about" aria-label="Open the link: /#about"><img class="header-picture" src="https://www.buildabear.com/dw/image/v2/BBNG_PRD/on/demandware.static/-/Sites-buildabear-master/default/dwdfa7c1cf/27618_27630_25342_24630x.jpg?sw=600&amp;sh=600&amp;sm=fit&amp;q=70" alt="Author&#39;s picture"></a></header><nav id="sidebar" data-behavior="4"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about" aria-label="Read more about the author"><img class="sidebar-profile-picture" src="https://www.buildabear.com/dw/image/v2/BBNG_PRD/on/demandware.static/-/Sites-buildabear-master/default/dwdfa7c1cf/27618_27630_25342_24630x.jpg?sw=600&amp;sh=600&amp;sm=fit&amp;q=70" alt="Author&#39;s picture"></a><h4 class="sidebar-profile-name">Minh Luc</h4><h5 class="sidebar-profile-bio"><p>author.bio</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/" title="Home"><i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i> <span class="sidebar-button-desc">Home</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/categories" title="Categories"><i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i> <span class="sidebar-button-desc">Categories</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/tags" title="Tags"><i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i> <span class="sidebar-button-desc">Tags</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/archives" title="Archives"><i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i> <span class="sidebar-button-desc">Archives</span></a></li><li class="sidebar-button"><a class="sidebar-button-link open-algolia-search" href="#search" title="Search"><i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i> <span class="sidebar-button-desc">Search</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/about" title="About"><i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i> <span class="sidebar-button-desc">About</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/minhlucvan" title="GitHub"><i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="http://stackoverflow.com/users" title="Stack Overflow"><i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i> <span class="sidebar-button-desc">Stack Overflow</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://twitter.com/" title="Twitter"><i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i> <span class="sidebar-button-desc">Twitter</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://facebook.com/minhlucvan.3" title="Facebook"><i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i> <span class="sidebar-button-desc">Facebook</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://plus.google.com/" title="Google +"><i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i> <span class="sidebar-button-desc">Google +</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="https://www.linkedin.com/profile/" title="LinkedIn"><i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i> <span class="sidebar-button-desc">LinkedIn</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:luk.mink@gmail.com" title="Mail"><i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i> <span class="sidebar-button-desc">Mail</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml" title="RSS"><i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div class="post-header-cover text-left" style="background-image:url(/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/plugin.png)" data-behavior="4"></div><div id="main" data-behavior="4" class="hasCover hasCoverMetaOut"><article class="post"><div class="post-header main-content-wrap text-left"><h1 class="post-title">viết một chương trình cho phép cài plugin trong java như thế nào?</h1><div class="post-meta"><time datetime="2016-08-06T19:08:51+07:00">Th08 06, 2016 </time><span>in </span><a class="category-link" href="/categories/lap-trinh/">lập trình</a></div></div><div class="post-content markdown"><div class="main-content-wrap"><p>Chả là đang tập tọe làm wordpress plugin, bỗng dưng nảy ra câu hỏi thế cài đặt plugin trong java như thế nào. Trước giờ cũng chỉ làm theo kiểu yêu cầu đến đâu viết đến đấy chứ chưa được làm kiểu plugin này bao giờ cả. Đành hỏi bác Gúc vậy. sau một hồi đào bới cũng gọi là nắm đưọc đôi phần, note ra đây cho bác nào cùng chung thắc mắc.</p><a id="more"></a><h1>plugin là khỉ gì?</h1><p>Nói thế chứ plugin chắc không lạ gì rồi, điển hình như các thể loại trình duyệt phổ biến như Chrome, Firefox, Opera kiểu gì mỗi cái chả cài một đống plugin đến khi trình duyệt có gì bất thường lại chả lôi đầu mấy thằng plugin ra kiểm ra đầu tiên. một cách đơn giản thì Plugin chính là một bộ phần mềm cài đặt để hỗ trợ, mở rộng chức năng cho một phần mềm ứng dụng lớn hơn, dựa trận nhưng giao thức và API do phần mềm lớn cung cấp.</p><h1>plugin có gì hay ho?</h1><p>Kiến trúc plugin thực sự rất tuyệt vời, nó cho phép mở rộng (thập chí là thay đổi) các chức năng của các host applications (tạm gọi là ứng dụng chủ đi), với một thiết kế tốt các ứng dụng có thể cắm thêm bao nhiêu chức năng tùy thích mỗi plugin mang đến một tiện ích dẫn đến khả năng mở rộng của hệ thống là cực kỳ tuyệt vời mình xin phép đưọc nhai lại một lần nữa là phải thiết kế cho tốt nhé không là ứng úng lỗi tùm lum đó.</p><p>Với cộng đồng mã nguồn mở phát triển như vũ bão ngày nay, với một ứng dụng có base tốt và một plugin API tối thì tốc độ phát triển sẽ không thể tin nổi. VD như <a href="https://www.youtube.com/watch?v=B6zVzWU95Sw" target="_blank" rel="noopener">slack</a> một hệ thống nhắn tin và trao đổi công việc đang rất nổi tuy cũng chỉ mới phát triển được vài năm nhưng số lượng plugin trong kho của slack đã rất khổng lồ hầu hết là do các bên thứ ba phảt triển, thực sự nâng giá trị của ứng dụng ban đầu lên gấp nhiều lần mà một team không thể làm hết được.</p><h1>rồi, thế cài đặt thằng này thế nào?</h1><p>Đối với các script language như Javascript, PHP, python… với dặc điểm mỗi lần chạy là một lần <strong>thông</strong> dịch thì có vẻ không gặp trở ngại gì chỉ việc dùng một thằng callback hay closure là xong cái này mình sẽ nói đến vào một ngày đẹp trời không xa. với java câu chuyện có vẻ không dễ dàng như thế, java 8 mới ra mắt tính năng <a href="http://www.linuxtopia.org/online_books/programming_books/thinking_in_java/TIJ310_019.htm" target="_blank" rel="noopener">Thinking</a> cho phép cài đặt callback &amp; closure một cách khá dễ dàng còn các ver thấp hơn thì không có cái gì tương tự cả, mình thì gà java nên cũng thấy vụ này hơi khoai.</p><p><img src="application-architecture.png" alt="application architecture"></p><p>Về cơ bản để có thể cắm được plugin thì ứng dụng phải có kiến trúc đơn giản nhất như trong hình trên, hai thành phần cơ bản đó là application core và plugin manager:<br>- <strong>application core:</strong> thằng này là ứng dụng chủ có nhiệm bụ bào đảm logic của hệ thống, thực hiện các tác vụ và hook (gọi) các plugin thực hiện nhiệm vụ của mình trong runtime.<br>- <strong>plugins manager:</strong> thằng chịu sự chỉ đạo của thằng core có nhiệm vụ đăng ký các plugin thêm, gỡ, bật, tắt các plugin.</p><p>Để có thể cắm được plugin ta phải có một plugin interface đây là giao diện mà tất cả các plugin sẽ kế thừa, plugin manager sẻ load các plugins và initial (nôm na là tạo ra thực thể của mỗi plugin) vào trong một List các plugins rồi từ đó application core sẽ lần lưọt móc ra từ cái một và bắt nó thực hiện nhiệm vụ nhất định.</p><p>Hì, mình giải thích củ chuối quá chắc ko ai hiểu nổi nhỉ. để trực quan sinh động mời ae xem ví dụ bên dưới.</p><h1>ví dụ trực quan nè</h1><p>Ở ví dụ này mình sẽ tạo một ứng dụng đơn giẩn với đầu vào là 1 số, các plugin sẽ đưọc thêm vào đê chế biến số đó để đưa ra kết quả cuối cùng cộng trừ nhân chia gì đó.</p><p>Ok, đầu tiên chúng ta phải có một thằng interface chung cho các plugins. tạm gọi là <code>PluginFunction.java</code> đi.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PluginFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// let the application pass in a parameter</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span> <span class="params">(<span class="keyword">int</span> param)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// retrieve a result from the plugin</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getResult</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// return the name of this plugin</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPluginName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// can be called to determine whether the plugin</span></span><br><span class="line">	<span class="comment">// aborted execution due to an error condition</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasError</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tiếp theo ta phải có một cái main để chạy logic của ứng dụng và gọi các plugin, ta gọi là <code>PluginDemo.java</code> chứa hàm main.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginDemo</span> </span>&#123;</span><br><span class="line">	<span class="comment">//parameter for plugins</span></span><br><span class="line">	<span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// the directory where we keep the plugin classes</span></span><br><span class="line">	String pluginsDir;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// a list where we keep an initialized object of each plugin class</span></span><br><span class="line">	List plugins;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">		PluginDemo demo = <span class="keyword">new</span> PluginDemo(args);</span><br><span class="line">		demo.getPlugins();</span><br><span class="line">		demo.runPlugins();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PluginDemo (String args[]) &#123;</span><br><span class="line">		<span class="keyword">if</span> (args.length &gt; <span class="number">0</span>)</span><br><span class="line">			count = Integer.parseInt(args[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (args.length &gt; <span class="number">1</span>)</span><br><span class="line">			pluginsDir = args[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			pluginsDir = <span class="string">"plugins"</span>;</span><br><span class="line"></span><br><span class="line">		plugins = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">		System.setSecurityManaghttps:<span class="comment">//analytics.google.com/analytics/web/?authuser=0#croverview/cr-overview/a79213161w118319613p123773431/er(new PluginSecurityManager(pluginsDir));</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">getPlugins</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		File dir = <span class="keyword">new</span> File(System.getProperty(<span class="string">"user.dir"</span>) + File.separator + pluginsDir);</span><br><span class="line">		ClassLoader cl = <span class="keyword">new</span> PluginClassLoader(dir);</span><br><span class="line">		<span class="keyword">if</span> (dir.exists() &amp;&amp; dir.isDirectory()) &#123;</span><br><span class="line">			<span class="comment">// we'll only load classes directly in this directory -</span></span><br><span class="line">			<span class="comment">// no subdirectories, and no classes in packages are recognized</span></span><br><span class="line">			String[] files = dir.list();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;files.length; i++) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">// only consider files ending in ".class"</span></span><br><span class="line">					<span class="keyword">if</span> (! files[i].endsWith(<span class="string">".class"</span>))</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">					Class c = cl.loadClass(files[i].substring(<span class="number">0</span>, files[i].indexOf(<span class="string">"."</span>)));</span><br><span class="line">					Class[] intf = c.getInterfaces();</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;intf.length; j++) &#123;</span><br><span class="line">						<span class="keyword">if</span> (intf[j].getName().equals(<span class="string">"PluginFunction"</span>)) &#123;</span><br><span class="line">							<span class="comment">// the following line assumes that PluginFunction has a no-argument constructor</span></span><br><span class="line">							PluginFunction pf = (PluginFunction) c.newInstance();</span><br><span class="line">							plugins.add(pf);</span><br><span class="line">							<span class="keyword">continue</span>;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">					System.err.println(<span class="string">"File "</span> + files[i] + <span class="string">" does not contain a valid PluginFunction class."</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">runPlugins</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Iterator iter = plugins.iterator();</span><br><span class="line">		<span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">			PluginFunction pf = (PluginFunction) iter.next();</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				pf.setParameter(count);</span><br><span class="line">				System.out.print(pf.getPluginName());</span><br><span class="line">				System.out.print(<span class="string">" ( "</span>+count+<span class="string">" ) = "</span>);</span><br><span class="line">				<span class="keyword">if</span> (pf.hasError()) &#123;</span><br><span class="line">					System.out.println(<span class="string">"there was an error during plugin initialization"</span>);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">int</span> result = pf.getResult();</span><br><span class="line">				<span class="keyword">if</span> (pf.hasError())</span><br><span class="line">					System.out.println(<span class="string">"there was an error during plugin execution"</span>);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					System.out.println(result);</span><br><span class="line">				count++;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (SecurityException secEx) &#123;</span><br><span class="line">				System.err.println(<span class="string">"plugin '"</span>+pf.getClass().getName()+<span class="string">"' tried to do something illegal"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ta thấy trong hàm <code>getPlugins</code> có một vòng for để load hết các class mà có interface là <code>PluginFunction</code> rồi tạo ra một thực thể của class đó và lưu vào mảng <code>plugins</code>. Sau đó hàm <code>runPlugins</code> sẽ duyệt qua tất cả cảc plugins set tham số chạy hàm run của từng plugin và in ra kết quả.</p><p>Ngoài ra hàm <code>getPlugins</code> còn có một điều thú vị nữa chính là dòng setSecurityManager, vì đây là các plugins độc lập với hệ thống nên ta phhair xét quền hạn cho nó chứ nhỡ thanh niên nào vui tính lại cho cái plugin xóa hết hệ điều hành thì chỉ biết ngồi đấy mà khóc thôi 😭.</p><p>Đây là nội dung file <code>PluginSecurityManager.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* This is a fairly uptight security manager subclass. Classes loaded by</span></span><br><span class="line"><span class="comment">* the PluginClassLoader are highly restricted in what they are allowed to do.</span></span><br><span class="line"><span class="comment">* This is okay, because they're only supposed to calculate some values,</span></span><br><span class="line"><span class="comment">* for which all necessary data is already available to them.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* A SecurityManager consists of various methods that the system calls to</span></span><br><span class="line"><span class="comment">* check whether certain sensitive operations should be allowed. These</span></span><br><span class="line"><span class="comment">* methods can throw a SecurityException to prevent the operation from</span></span><br><span class="line"><span class="comment">* happening. With this SecurityManager, we want to prevent untrusted</span></span><br><span class="line"><span class="comment">* code that was loaded by a class loader from performing those sensitive operations.</span></span><br><span class="line"><span class="comment">* So we use inherited SecurityManager methods to check whether the call is being</span></span><br><span class="line"><span class="comment">* made by an untrusted class. If it is, we throw an exception.</span></span><br><span class="line"><span class="comment">* Otherwise, we simply return, allowing the operation to proceed normally.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginSecurityManager</span> <span class="keyword">extends</span> <span class="title">SecurityManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String pluginDir = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	PluginSecurityManager (String dir) &#123;</span><br><span class="line">		pluginDir = dir;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * This is the basic method that tests whether there is a class loaded</span></span><br><span class="line"><span class="comment">	 * by a ClassLoader anywhere on the stack. If so, it means that that</span></span><br><span class="line"><span class="comment">	 * untrusted code is trying to perform some kind of sensitive operation.</span></span><br><span class="line"><span class="comment">	 * We prevent it from performing that operation by throwing an exception.</span></span><br><span class="line"><span class="comment">	 * trusted() is called by most of the check...() methods below.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">trusted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (inClassLoader()) <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * These are all the specific checks that a security manager can</span></span><br><span class="line"><span class="comment">	 * perform. They all just call one of the methods above and throw a</span></span><br><span class="line"><span class="comment">	 * SecurityException if the operation is not allowed. This </span></span><br><span class="line"><span class="comment">	 * SecurityManager subclass is perhaps a little too restrictive. For</span></span><br><span class="line"><span class="comment">	 * example, it doesn't allow loaded code to read *any* system properties,</span></span><br><span class="line"><span class="comment">	 * even though some of them are quite harmless.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkCreateClassLoader</span><span class="params">()</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAccess</span> <span class="params">(Thread g)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAccess</span> <span class="params">(ThreadGroup g)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkExit</span> <span class="params">(<span class="keyword">int</span> status)</span> </span>&#123; <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Not allowed."</span>); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkExec</span> <span class="params">(String cmd)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkLink</span> <span class="params">(String lib)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkRead</span> <span class="params">(java.io.FileDescriptor fd)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkRead</span> <span class="params">(String file)</span> </span>&#123;</span><br><span class="line"><span class="comment">//		String path = new File(file).getParentFile().getAbsolutePath();</span></span><br><span class="line"><span class="comment">//		if (! path.endsWith(pluginDir))</span></span><br><span class="line">			trusted();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkRead</span> <span class="params">(String file, Object context)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkWrite</span> <span class="params">(java.io.FileDescriptor fd)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkWrite</span> <span class="params">(String file)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkDelete</span> <span class="params">(String file)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkConnect</span> <span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkConnect</span> <span class="params">(String host,<span class="keyword">int</span> port,Object context)</span> </span>&#123;trusted();&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkListen</span> <span class="params">(<span class="keyword">int</span> port)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAccept</span> <span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkMulticast</span> <span class="params">(java.net.InetAddress maddr)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkMulticast</span> <span class="params">(java.net.InetAddress maddr, <span class="keyword">byte</span> ttl)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPropertiesAccess</span><span class="params">()</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPropertyAccess</span> <span class="params">(String key)</span> </span>&#123;</span><br><span class="line"><span class="comment">//		if (! key.equals("user.dir"))</span></span><br><span class="line">			trusted();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPrintJobAccess</span><span class="params">()</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkSystemClipboardAccess</span><span class="params">()</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAwtEventQueueAccess</span><span class="params">()</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkSetFactory</span><span class="params">()</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkMemberAccess</span> <span class="params">(Class clazz, <span class="keyword">int</span> which)</span> </span>&#123; trusted(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkSecurityAccess</span> <span class="params">(String provider)</span> </span>&#123; trusted(); &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Loaded code can only load classes from java.* packages */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPackageAccess</span> <span class="params">(String pkg)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span> (inClassLoader() &amp;&amp; !pkg.startsWith(<span class="string">"java."</span>) &amp;&amp; !pkg.startsWith(<span class="string">"javax."</span>))</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SecurityException();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Loaded code can't define classes in java.* or sun.* packages */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPackageDefinition</span> <span class="params">(String pkg)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span> (inClassLoader() &amp;&amp; ((pkg.startsWith(<span class="string">"java."</span>) || pkg.startsWith(<span class="string">"javax."</span>) || pkg.startsWith(<span class="string">"sun."</span>))))</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SecurityException();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * This is the one SecurityManager method that is different from the</span></span><br><span class="line"><span class="comment">	 * others. It indicates whether a top-level window should display an</span></span><br><span class="line"><span class="comment">	 * "untrusted" warning. The window is always allowed to be created, so</span></span><br><span class="line"><span class="comment">	 * this method is not normally meant to throw an exception. It should</span></span><br><span class="line"><span class="comment">	 * return true if the window does not need to display the warning, and</span></span><br><span class="line"><span class="comment">	 * false if it does. In this example, however, our text-based Service</span></span><br><span class="line"><span class="comment">	 * classes should never need to create windows, so we will actually</span></span><br><span class="line"><span class="comment">	 * throw an exception to prevent any windows from being opened.</span></span><br><span class="line"><span class="comment">	 **/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkTopLevelWindow</span> <span class="params">(Object window)</span> </span>&#123; </span><br><span class="line">		trusted();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ngoài ra ta còn cần 1 cái loader để load các plugins ra nữa <code>PluginClassLoader.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * In order to impose tight security restrictions on untrusted classes but</span></span><br><span class="line"><span class="comment">   * not on trusted system classes, we have to be able to distinguish between</span></span><br><span class="line"><span class="comment">   * those types of classes. This is done by keeping track of how the classes</span></span><br><span class="line"><span class="comment">   * are loaded into the system. By definition, any class that the interpreter</span></span><br><span class="line"><span class="comment">   * loads directly from the CLASSPATH is trusted. This means that we can't</span></span><br><span class="line"><span class="comment">   * load untrusted code in that way--we can't load it with Class.forName().</span></span><br><span class="line"><span class="comment">   * Instead, we create a ClassLoader subclass to load the untrusted code.</span></span><br><span class="line"><span class="comment">   * This one loads classes from a specified directory (which should not</span></span><br><span class="line"><span class="comment">   * be part of the CLASSPATH).</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** This is the directory from which the classes will be loaded */</span></span><br><span class="line">    File directory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The constructor. Just initialize the directory */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginClassLoader</span> <span class="params">(File dir)</span> </span>&#123;</span><br><span class="line">		directory = dir;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A convenience method that calls the 2-argument form of this method */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">loadClass</span> <span class="params">(String name)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123; </span><br><span class="line">      <span class="keyword">return</span> loadClass(name, <span class="keyword">true</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is one abstract method of ClassLoader that all subclasses must</span></span><br><span class="line"><span class="comment">     * define. Its job is to load an array of bytes from somewhere and to</span></span><br><span class="line"><span class="comment">     * pass them to defineClass(). If the resolve argument is true, it must</span></span><br><span class="line"><span class="comment">     * also call resolveClass(), which will do things like verify the presence</span></span><br><span class="line"><span class="comment">     * of the superclass. Because of this second step, this method may be called to</span></span><br><span class="line"><span class="comment">     * load superclasses that are system classes, and it must take this into account.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">loadClass</span> <span class="params">(String classname, <span class="keyword">boolean</span> resolve)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Our ClassLoader superclass has a built-in cache of classes it has</span></span><br><span class="line">        <span class="comment">// already loaded. So, first check the cache.</span></span><br><span class="line">        Class c = findLoadedClass(classname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// After this method loads a class, it will be called again to</span></span><br><span class="line">        <span class="comment">// load the superclasses. Since these may be system classes, we've</span></span><br><span class="line">        <span class="comment">// got to be able to load those too. So try to load the class as</span></span><br><span class="line">        <span class="comment">// a system class (i.e. from the CLASSPATH) and ignore any errors</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123; c = findSystemClass(classname); &#125;</span><br><span class="line">          <span class="keyword">catch</span> (Exception ex) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the class wasn't found by either of the above attempts, then</span></span><br><span class="line">        <span class="comment">// try to load it from a file in (or beneath) the directory</span></span><br><span class="line">        <span class="comment">// specified when this ClassLoader object was created. Form the</span></span><br><span class="line">        <span class="comment">// filename by replacing all dots in the class name with</span></span><br><span class="line">        <span class="comment">// (platform-independent) file separators and by adding the ".class" extension.</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// Figure out the filename</span></span><br><span class="line">          String filename = classname.replace(<span class="string">'.'</span>,File.separatorChar)+<span class="string">".class"</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Create a File object. Interpret the filename relative to the</span></span><br><span class="line">          <span class="comment">// directory specified for this ClassLoader.</span></span><br><span class="line">          File f = <span class="keyword">new</span> File(directory, filename);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Get the length of the class file, allocate an array of bytes for</span></span><br><span class="line">          <span class="comment">// it, and read it in all at once.</span></span><br><span class="line">          <span class="keyword">int</span> length = (<span class="keyword">int</span>) f.length();</span><br><span class="line">          <span class="keyword">byte</span>[] classbytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">          DataInputStream in = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> FileInputStream(f));</span><br><span class="line">          in.readFully(classbytes);</span><br><span class="line">          in.close();</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Now call an inherited method to convert those bytes into a Class</span></span><br><span class="line">          c = defineClass(classname, classbytes, <span class="number">0</span>, length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the resolve argument is true, call the inherited resolveClass method.</span></span><br><span class="line">        <span class="keyword">if</span> (resolve) resolveClass(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// And we're done. Return the Class object we've loaded.</span></span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If anything goes wrong, throw a ClassNotFoundException error</span></span><br><span class="line">      <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(ex.toString()); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Haiz, về cơ bản hệ thống setup thế là xong, tiếp theo ta sẽ cần 1 2 cái plugins để test thủ xem nó có chạy ổn không, ta sẽ đặt các file này trong thư mục <code>plugins</code>.</p><p><code>Square.java</code> tình bình phưng của tham số:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This plugin squares its argument.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">implements</span> <span class="title">PluginFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> parameter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span> <span class="params">(<span class="keyword">int</span> param)</span> </span>&#123;</span><br><span class="line">		parameter = param;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameter * parameter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPluginName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"Square"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// yes, this operation can fail, but we are going to ignore this here</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PlusOne.java</code> cộng 1 đơn vị vào tham số:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This plugin adds one to the parameter.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlusOne</span> <span class="keyword">implements</span> <span class="title">PluginFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> parameter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span> <span class="params">(<span class="keyword">int</span> param)</span> </span>&#123;</span><br><span class="line">		parameter = param;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> parameter + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPluginName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"PlusOne"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// yes, ths operation can fail, but we are going to ignore this here</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TryToExit.java</code> thử cho thanh niên này lạm quền tý xem có đưọc không, trong <code>PluginSecurityManager</code> ta đã set không cho plugin thoát chương trình rồi.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This plugin tries to call System.exit(), which the SecurityManager doesn't allow.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TryToExit</span> <span class="keyword">implements</span> <span class="title">PluginFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span> <span class="params">(<span class="keyword">int</span> param)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// this function doesn't care about its parameter,</span></span><br><span class="line">		<span class="comment">// so it doesn't even store it for later use</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// The next line will be caught by the SecurityManagers 'checkExit' method.</span></span><br><span class="line">		System.exit(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPluginName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"TryToExit"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// yes, this operation can fail, but we are going to ignore this here</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tiếp theo là dịch và chạy thử, nếu không có gì sai thì sẽ thu được output như này, mình dùng java 8 nên có phun ra mấy cái Note, thôi kệ dù sao nó vẫn chạy được 😄:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">minh@MINH-PC:~/Desktop/Plugin$ javac *.java</span><br><span class="line">Note: PluginSecurityManager.java uses or overrides a deprecated API.</span><br><span class="line">Note: Recompile with -Xlint:deprecation for details.</span><br><span class="line">Note: PluginDemo.java uses unchecked or unsafe operations.</span><br><span class="line">Note: Recompile with -Xlint:unchecked for details.</span><br><span class="line">minh@MINH-PC:~/Desktop/Plugin$ java PluginDemo</span><br><span class="line">TryToExit ( 1 ) = plugin 'TryToExit' tried to do something illegal</span><br><span class="line">PlusOne ( 1 ) = 2</span><br><span class="line">Square ( 2 ) = 4</span><br></pre></td></tr></table></figure><p>Thực ra toppic này còn thêm vấn đề nữa là build ra file jar và cài đặt plugin bằng xml nhưng tạp thời thế này đã. xin hẹn ae một dịp khác.</p><p>Xin chân thành cảm ơn bộ code mẫu của <a href="http://www.javaranch.com/contact.jsp#UlfDittmer" target="_blank" rel="noopener">@Ulf Dittmer</a>, các bạn code thể <a href="Plugin.zip">download</a> code dể tham khảo.</p><p>Phùu… cảm ơn ae đã theo dõi đến tận đây, bài đã dài tay quay đã mỏi mình xin phép dừng phím tại đây. chúc ae cuối tuần vui vẻ.<br>xin chào thân ái và quết thắng.</p></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">TAGGED IN</span><br><a class="tag tag--primary tag--small t-link" href="/tags/design-pattern/">design pattern</a> <a class="tag tag--primary tag--small t-link" href="/tags/java/">java</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2016/08/07/Flux-la-cai-quai-gi-nhi/" data-tooltip="Flux là cái quái gì nhỉ" aria-label="PREVIOUS: Flux là cái quái gì nhỉ"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2016/08/06/BOOK-ca-phe-cung-Tony-ly-ca-phe-dam-da-huong-vi-cuoc-song/" data-tooltip="Cà phê cùng Tony - ly cà phê đậm đà  hương vị cuộc sống" aria-label="NEXT: Cà phê cùng Tony - ly cà phê đậm đà  hương vị cuộc sống"><span class="hide-xs hide-sm text-small icon-mr">NEXT</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" title="Share on Google+" aria-label="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Back to top"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2019 Minh Luc. All Rights Reserved.</span></footer></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="4"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2016/08/07/Flux-la-cai-quai-gi-nhi/" data-tooltip="Flux là cái quái gì nhỉ" aria-label="PREVIOUS: Flux là cái quái gì nhỉ"><i class="fa fa-angle-left" aria-hidden="true"></i> <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2016/08/06/BOOK-ca-phe-cung-Tony-ly-ca-phe-dam-da-huong-vi-cuoc-song/" data-tooltip="Cà phê cùng Tony - ly cà phê đậm đà  hương vị cuộc sống" aria-label="NEXT: Cà phê cùng Tony - ly cà phê đậm đà  hương vị cuộc sống"><span class="hide-xs hide-sm text-small icon-mr">NEXT</span> <i class="fa fa-angle-right" aria-hidden="true"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post"><i class="fa fa-share-alt" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" title="Share on Facebook" aria-label="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" title="Share on Twitter" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" title="Share on Google+" aria-label="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#" aria-label="Back to top"><i class="fa fa-list" aria-hidden="true"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="4"><i id="btn-close-shareoptions" class="fa fa-times"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" aria-label="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" aria-label="Share on Twitter"><i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://plus.google.com/share?url=/2016/08/06/viet-mot-chuong-trinh-cho-phep-cai-plugin-trong-java-nhu-the-nao/" aria-label="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-times"></i></div><img id="about-card-picture" src="https://www.buildabear.com/dw/image/v2/BBNG_PRD/on/demandware.static/-/Sites-buildabear-master/default/dwdfa7c1cf/27618_27630_25342_24630x.jpg?sw=600&amp;sh=600&amp;sm=fit&amp;q=70" alt="Author&#39;s picture"><h4 id="about-card-name">Minh Luc</h4><div id="about-card-bio"><p>author.bio</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>author.job</p></div><div id="about-card-location"><i class="fa fa-map-marker-alt"></i><br>Hanoi, Vietnam</div></div></div><div id="cover" style="background-image:url(/assets/images/cover-v1.2.0.jpg)"></div><script src="/assets/js/script-v5hftjqfholivslt8zs7notwx80qctz8sotsfl1pxlrg8swcj6ncpoq2rqih.min.js"></script></body></html>